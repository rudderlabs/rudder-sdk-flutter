name: Draft new release

on:
  workflow_dispatch:

jobs:
  draft-new-release:
    name: Draft a new release
    runs-on: ubuntu-latest
    permissions:
      contents: read  # GITHUB_TOKEN only needs read for checkout
    if: startsWith(github.ref, 'refs/heads/develop') || startsWith(github.ref, 'refs/heads/hotfix/')
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit

      - name: Generate GitHub App Token
        id: generate-token
        uses: actions/create-github-app-token@67018539274d69449ef7c02e8e71183d1719ab42 # v2.1.4
        with:
          app-id: ${{ vars.RELEASE_APP_ID }}
          private-key: ${{ secrets.RELEASE_PRIVATE_KEY }}
          permission-contents: write # to create commits, tags, and branches
          permission-pull-requests: write # to create PRs that trigger CI checks

      - name: Checkout source branch
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0
        with:
          token: ${{ steps.generate-token.outputs.token }}
          fetch-depth: 0

      - name: Setup Dart
        uses: dart-lang/setup-dart@e51d8e571e22473a2ddebf0ef8a2123f0ab2c02c #v1.3

      - name: Setup Java
        uses: actions/setup-java@c5195efecf7bdfc987ee8bae7a71cb8b11521c00 # v4.7.1
        with:
          distribution: 'zulu'
          java-version: '11'

      - name: Setup Flutter
        uses: subosito/flutter-action@fd55f4c5af5b953cc57a2be44cb082c8f6635e8e #v2.21.0
        with:
          channel: 'stable'
          architecture: x64

      - name: Install Melos
        run: |
          dart pub global activate melos 6.3.3

      # In order to make a commit, we need to initialize a user.
      # You may choose to write something less generic here if you want, it doesn't matter functionality wise.
      - name: Initialize mandatory git config
        run: |
          git config user.name "GitHub actions"
          git config user.email noreply@github.com

      # Calculate the next release version based on conventional semantic release
      - name: Create release branch
        id: create-release
        env:
          GH_TOKEN: ${{ steps.generate-token.outputs.token }}
        run: |
          source_branch_name=${GITHUB_REF##*/}
          release_type=release
          grep -q "hotfix/" <<< "${GITHUB_REF}" && release_type=hotfix-release
          git fetch origin main
          git fetch --tags origin
          git merge origin/main
          current_version=$(grep -A0 'version:' pubspec.yaml | tail -n1 | awk '{ print $2 }')

          melos version -a --no-git-tag-version --no-changelog --yes --no-git-commit-version
          new_version=$(grep -A0 'version:' pubspec.yaml | tail -n1 | awk '{ print $2 }')
          git reset --hard

          branch_name="${release_type}/${new_version}"

          echo "Source branch for new release is $source_branch_name"
          echo "Current version is $current_version"
          echo "Release type is $release_type"
          echo "New version is $new_version"
          echo "New release branch name is $branch_name"
          git checkout -b "$branch_name"

          echo "source_branch_name=$source_branch_name" >> $GITHUB_OUTPUT
          echo "branch_name=$branch_name" >> $GITHUB_OUTPUT
          echo "new_version=$new_version" >> $GITHUB_OUTPUT
          echo "CURRENT_VERSION_VALUE=$current_version" >> $GITHUB_ENV
          echo "NEW_VERSION_VALUE=$new_version" >> $GITHUB_ENV

      - name: Push signed release branch
        uses: ryancyq/github-signed-commit@e9f3b28c80da7be66d24b8f501a5abe82a6b855f # v1.2.0
        with:
          token: ${{ steps.generate-token.outputs.token }}
          branch: ${{ steps.create-release.outputs.branch_name }}
          commit-message: "chore: create release branch ${{ steps.create-release.outputs.branch_name }}"
          force: true

      - name: Update changelog & bump version
        id: finish-release
        run: |
          echo "Current version: $CURRENT_VERSION_VALUE"
          echo "New version: $NEW_VERSION_VALUE"
          npx replace $CURRENT_VERSION_VALUE $NEW_VERSION_VALUE sonar-project.properties
          git add sonar-project.properties
          melos version -a --yes

      - name: Prepare version changes
        env:
          GH_TOKEN: ${{ steps.generate-token.outputs.token }}
        run: |
          git add .
          git commit --amend --no-edit
          git for-each-ref refs/tags

      - name: Push signed version changes and tags
        uses: ryancyq/github-signed-commit@e9f3b28c80da7be66d24b8f501a5abe82a6b855f # v1.2.0
        with:
          token: ${{ steps.generate-token.outputs.token }}
          branch: ${{ steps.create-release.outputs.branch_name }}
          commit-message: "chore: version bump to ${{ steps.create-release.outputs.new_version }}"
          force: true
          tags: true

      - name: Create pull request into main
        uses: repo-sync/pull-request@7e79a9f5dc3ad0ce53138f01df2fad14a04831c5 #v2
        with:
          source_branch: ${{ steps.create-release.outputs.branch_name }}
          destination_branch: 'main'
          github_token: ${{ steps.generate-token.outputs.token }}
          pr_title: 'chore(release): pull ${{ steps.create-release.outputs.branch_name }} into main'
          pr_body: ':crown: *An automated PR*'
